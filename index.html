<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å®¶è¨ˆç°¿ â€” KAKEIBO</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&family=Pacifico&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --rose:     #f4768a;
  --rose-d:   #e05570;
  --rose-l:   #fce4ea;
  --rose-ll:  #fff0f4;
  --peach:    #ffb3c1;
  --coral:    #ff8fa3;
  --mint:     #52b788;
  --mint-l:   #d8f3dc;
  --lavender: #c77dff;
  --lav-l:    #f0d9ff;
  --gold:     #e9a84c;
  --ink:      #3d1a24;
  --ink-m:    #7a4a58;
  --muted:    #b8849a;
  --border:   #f0c8d5;
  --paper:    #fff8fa;
  --cream:    #fde8ef;
  --shadow:   rgba(244,118,138,0.15);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans JP', sans-serif;
  background: var(--paper);
  color: var(--ink);
  min-height: 100vh;
  background-image:
    radial-gradient(circle at 20% 20%, rgba(255,179,193,0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(199,125,255,0.08) 0%, transparent 50%);
}

/* ===== HEADER ===== */
header {
  background: linear-gradient(135deg, var(--rose) 0%, var(--coral) 100%);
  color: white;
  padding: 14px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 4px 20px var(--shadow);
}

.logo {
  font-family: 'Pacifico', cursive;
  font-size: 26px;
  color: white;
  text-shadow: 0 2px 8px rgba(0,0,0,0.15);
  letter-spacing: 1px;
}
.logo span {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 10px;
  display: block;
  letter-spacing: 3px;
  opacity: 0.85;
  margin-top: -2px;
  font-weight: 400;
}

.header-right { display: flex; align-items: center; gap: 12px; }

.month-nav { display: flex; align-items: center; gap: 10px; }
.month-nav button {
  background: rgba(255,255,255,0.25);
  border: none;
  color: white;
  width: 30px; height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.month-nav button:hover { background: rgba(255,255,255,0.4); }
#currentMonth {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 14px;
  min-width: 100px;
  text-align: center;
  color: white;
}

#wsStatus {
  font-size: 10px;
  font-family: 'Zen Maru Gothic', sans-serif;
  letter-spacing: 1px;
  padding: 4px 10px;
  border-radius: 20px;
  background: rgba(255,255,255,0.2);
  color: white;
}

#changePwBtn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 11px;
  font-family: 'Zen Maru Gothic', sans-serif;
  transition: background 0.2s;
}
#changePwBtn:hover { background: rgba(255,255,255,0.35); }

/* ===== LAYOUT ===== */
.container { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }

/* ===== SUMMARY CARDS ===== */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.summary-card {
  background: white;
  border-radius: 20px;
  padding: 20px 24px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 20px var(--shadow);
  animation: fadeUp 0.4s ease both;
}
.summary-card::before {
  content: '';
  position: absolute;
  top: -20px; right: -20px;
  width: 80px; height: 80px;
  border-radius: 50%;
  opacity: 0.12;
}
.summary-card.income::before { background: var(--mint); }
.summary-card.expense::before { background: var(--rose); }
.summary-card.balance::before { background: var(--lavender); }

.card-label {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--muted);
  margin-bottom: 6px;
}
.card-amount {
  font-size: 28px;
  font-weight: 700;
  line-height: 1;
}
.card-amount.income  { color: var(--mint); }
.card-amount.expense { color: var(--rose); }
.card-amount.balance-positive { color: var(--lavender); }
.card-amount.balance-negative { color: var(--rose-d); }
.card-sub { font-size: 11px; color: var(--muted); margin-top: 6px; }

/* ===== MAIN GRID ===== */
.main-grid {
  display: grid;
  grid-template-columns: 360px 1fr;
  gap: 20px;
}

/* ===== PANEL ===== */
.panel {
  background: white;
  border-radius: 20px;
  box-shadow: 0 4px 20px var(--shadow);
  overflow: hidden;
}

.panel-header {
  background: linear-gradient(135deg, var(--rose-l), var(--cream));
  color: var(--rose-d);
  padding: 13px 20px;
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px;
  letter-spacing: 2px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ===== FORM ===== */
.form-body { padding: 18px 20px; }
.form-row { margin-bottom: 14px; }
label {
  display: block;
  font-size: 11px;
  font-family: 'Zen Maru Gothic', sans-serif;
  letter-spacing: 1px;
  color: var(--muted);
  margin-bottom: 5px;
}
input, select {
  width: 100%;
  padding: 9px 12px;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  background: var(--rose-ll);
  font-family: 'Noto Sans JP', sans-serif;
  font-size: 14px;
  color: var(--ink);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  appearance: none;
}
input:focus, select:focus {
  border-color: var(--rose);
  box-shadow: 0 0 0 3px rgba(244,118,138,0.15);
  background: white;
}

.type-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.type-toggle button {
  padding: 10px;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  background: var(--rose-ll);
  cursor: pointer;
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 13px;
  transition: all 0.2s;
  color: var(--muted);
}
.type-toggle button.active-income  { background: var(--mint-l);  border-color: var(--mint);  color: var(--mint);  font-weight: 700; }
.type-toggle button.active-expense { background: var(--rose-l);  border-color: var(--rose);  color: var(--rose-d); font-weight: 700; }

.btn-submit {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, var(--rose), var(--coral));
  color: white;
  border: none;
  border-radius: 14px;
  cursor: pointer;
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 2px;
  transition: all 0.2s;
  box-shadow: 0 4px 12px var(--shadow);
  margin-top: 6px;
}
.btn-submit:hover { transform: translateY(-1px); box-shadow: 0 6px 16px var(--shadow); }
.btn-submit.green {
  background: linear-gradient(135deg, var(--mint), #2d9e6b);
  box-shadow: 0 4px 12px rgba(82,183,136,0.25);
}
.btn-submit.green:hover { box-shadow: 0 6px 16px rgba(82,183,136,0.3); }

/* ===== CSV Upload ===== */
.csv-zone {
  margin: 0 20px 16px;
  border: 2px dashed var(--border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--rose-ll);
}
.csv-zone:hover, .csv-zone.dragover {
  border-color: var(--rose);
  background: var(--rose-l);
}
.csv-icon { font-size: 28px; margin-bottom: 6px; }
.csv-zone p { font-size: 12px; color: var(--muted); font-family: 'Zen Maru Gothic', sans-serif; }
#csvInput { display: none; }
.csv-status {
  margin: 0 20px 16px;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 12px;
  font-family: 'Zen Maru Gothic', sans-serif;
  display: none;
}
.csv-status.loading { background: #fff8e1; color: var(--gold); }
.csv-status.success { background: var(--mint-l); color: var(--mint); }
.csv-status.error   { background: var(--rose-l); color: var(--rose-d); }

/* ===== TABS ===== */
.tabs { display: flex; border-bottom: 1.5px solid var(--border); padding: 0 4px; }
.tab {
  padding: 12px 18px;
  border: none;
  background: none;
  cursor: pointer;
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px;
  letter-spacing: 1px;
  color: var(--muted);
  border-bottom: 2px solid transparent;
  margin-bottom: -1.5px;
  transition: all 0.2s;
  border-radius: 8px 8px 0 0;
}
.tab.active { color: var(--rose-d); border-bottom-color: var(--rose); font-weight: 700; }

.tab-content { display: none; }
.tab-content.active { display: block; }

/* ===== TX LIST ===== */
.tx-list { max-height: 520px; overflow-y: auto; }
.tx-item {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  border-bottom: 1px solid var(--rose-ll);
  gap: 10px;
  transition: background 0.15s;
}
.tx-item:hover { background: var(--rose-ll); }
.tx-date { font-size: 11px; color: var(--muted); min-width: 40px; font-family: 'Zen Maru Gothic', sans-serif; }
.tx-cat { font-size: 18px; min-width: 26px; text-align: center; }
.tx-desc { flex: 1; font-size: 13px; }
.tx-memo { font-size: 10px; color: var(--muted); margin-top: 2px; }
.tx-amount { font-size: 14px; font-weight: 700; text-align: right; min-width: 95px; }
.tx-amount.income  { color: var(--mint); }
.tx-amount.expense { color: var(--rose); }
.tx-del {
  background: none; border: none; cursor: pointer;
  color: var(--border); font-size: 16px; padding: 2px;
  transition: color 0.2s; line-height: 1;
}
.tx-del:hover { color: var(--rose); }
.empty-state {
  padding: 50px 20px; text-align: center;
  color: var(--muted); font-size: 13px;
  font-family: 'Zen Maru Gothic', sans-serif; letter-spacing: 1px;
}
.empty-state::before { content: 'ğŸŒ¸'; display: block; font-size: 32px; margin-bottom: 10px; }

/* ===== CHARTS ===== */
.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; }
.chart-title {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 11px; letter-spacing: 2px; color: var(--muted);
  margin-bottom: 10px;
}
.chart-full { padding: 0 16px 16px; }

/* ===== CATEGORY BREAKDOWN ===== */
.cat-breakdown { padding: 16px 20px; }
.cat-bar-item { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.cat-emoji { font-size: 18px; min-width: 26px; text-align: center; }
.cat-name { font-size: 12px; }
.cat-bar-wrap { height: 6px; background: var(--rose-ll); border-radius: 10px; overflow: hidden; margin-top: 3px; }
.cat-bar { height: 100%; background: linear-gradient(90deg, var(--rose), var(--peach)); border-radius: 10px; transition: width 0.5s ease; }
.cat-amount { font-size: 12px; font-weight: 700; color: var(--rose); min-width: 85px; text-align: right; }

/* ===== SYNC NOTICE ===== */
.sync-notice {
  display: none;
  position: fixed; bottom: 24px; right: 24px;
  padding: 14px 20px; border-radius: 16px;
  font-family: 'Zen Maru Gothic', sans-serif; font-size: 12px;
  z-index: 9000; max-width: 340px;
  animation: fadeUp 0.3s ease;
  box-shadow: 0 8px 24px var(--shadow);
}
.sync-notice.success { background: var(--mint-l); color: var(--mint); }
.sync-notice.error   { background: var(--rose-l); color: var(--rose-d); }

/* ===== LOCK SCREEN ===== */
#lockScreen {
  position: fixed; inset: 0;
  background: linear-gradient(135deg, #f4768a 0%, #ff8fa3 40%, #c77dff 100%);
  z-index: 9999;
  display: flex; align-items: center; justify-content: center;
}
#lockScreen.hidden { display: none; }

.lock-box {
  text-align: center; width: 340px;
  animation: fadeUp 0.5s ease;
}
.lock-logo {
  font-family: 'Pacifico', cursive;
  font-size: 52px; color: white;
  text-shadow: 0 4px 20px rgba(0,0,0,0.15);
  margin-bottom: 4px;
}
.lock-sub {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 11px; letter-spacing: 3px; color: rgba(255,255,255,0.8);
  margin-bottom: 40px;
}
.lock-label {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 11px; letter-spacing: 2px; color: rgba(255,255,255,0.8);
  text-align: left; margin-bottom: 8px;
}
#lockPassword {
  width: 100%; padding: 14px 16px;
  background: rgba(255,255,255,0.25);
  border: 1.5px solid rgba(255,255,255,0.5);
  border-radius: 16px;
  color: white; font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 20px; letter-spacing: 6px;
  outline: none; text-align: center;
  transition: border-color 0.2s;
}
#lockPassword::placeholder { color: rgba(255,255,255,0.5); }
#lockPassword:focus { border-color: white; }
#lockPassword.shake { animation: shake 0.4s ease; border-color: rgba(255,255,255,0.3) !important; }
#lockBtn {
  width: 100%; margin-top: 14px; padding: 14px;
  background: white; color: var(--rose);
  border: none; border-radius: 16px; cursor: pointer;
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 14px; font-weight: 700; letter-spacing: 3px;
  transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}
#lockBtn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
#lockError {
  font-family: 'Zen Maru Gothic', sans-serif; font-size: 12px;
  color: rgba(255,255,255,0.9); margin-top: 10px; height: 18px;
}
.lock-hint {
  font-family: 'Zen Maru Gothic', sans-serif; font-size: 10px;
  color: rgba(255,255,255,0.5); margin-top: 40px; letter-spacing: 1px;
}

/* ===== PW MODAL ===== */
#pwModal {
  display: none; position: fixed; inset: 0;
  background: rgba(244,118,138,0.3); backdrop-filter: blur(4px);
  z-index: 9998; align-items: center; justify-content: center;
}
#pwModal.open { display: flex; }
.modal-box {
  background: white; border-radius: 24px;
  box-shadow: 0 20px 60px var(--shadow);
  padding: 28px; width: 320px;
  animation: fadeUp 0.3s ease;
}
.modal-title {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 14px; font-weight: 700;
  color: var(--rose-d); margin-bottom: 20px;
  letter-spacing: 1px;
}
.modal-box input { margin-bottom: 10px; }
.modal-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px; }
.modal-actions button {
  padding: 11px; border: none; border-radius: 12px;
  cursor: pointer; font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px; font-weight: 700; transition: all 0.2s;
}
.btn-cancel { background: var(--rose-ll); color: var(--muted); }
.btn-save   { background: linear-gradient(135deg, var(--rose), var(--coral)); color: white; }

/* ===== DEFAULT INCOME PANEL ===== */
.income-hint {
  font-size: 11px; color: var(--muted);
  font-family: 'Zen Maru Gothic', sans-serif;
  line-height: 1.8; margin-bottom: 14px;
}
.btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px; }
#defaultIncomeStatus {
  font-family: 'Zen Maru Gothic', sans-serif; font-size: 11px;
  color: var(--mint); margin-top: 10px; min-height: 16px;
}

/* ===== RULES PANEL ===== */
.rules-panel { padding: 16px 20px; }
.rules-hint {
  font-size: 11px; color: var(--muted);
  font-family: 'Zen Maru Gothic', sans-serif;
  line-height: 1.8; margin-bottom: 14px;
  background: var(--rose-ll); border-radius: 10px;
  padding: 10px 14px;
}
.rules-add-row {
  display: flex; gap: 8px; margin-bottom: 16px; align-items: center;
}
.rules-add-row input, .rules-add-row select {
  margin-bottom: 0;
}
.rules-add-btn {
  background: linear-gradient(135deg, var(--rose), var(--coral));
  color: white; border: none; border-radius: 10px;
  padding: 9px 16px; cursor: pointer;
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px; font-weight: 700;
  white-space: nowrap;
  transition: all 0.2s;
}
.rules-add-btn:hover { transform: translateY(-1px); }
.rules-list { display: flex; flex-direction: column; gap: 6px; max-height: 420px; overflow-y: auto; }
.rule-item {
  display: flex; align-items: center; gap: 10px;
  background: var(--rose-ll); border-radius: 10px;
  padding: 9px 14px; font-size: 13px;
}
.rule-keyword {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-weight: 700; color: var(--ink); flex: 1;
}
.rule-arrow { color: var(--muted); font-size: 12px; }
.rule-cat {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px; color: var(--rose-d);
  background: white; border-radius: 8px;
  padding: 3px 10px;
}
.rule-del {
  background: none; border: none; cursor: pointer;
  color: var(--border); font-size: 16px;
  transition: color 0.2s; line-height: 1;
}
.rule-del:hover { color: var(--rose); }
.rules-empty {
  text-align: center; color: var(--muted);
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px; padding: 30px 0;
}

.rules-section-title {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 13px; font-weight: 700;
  color: var(--rose-d); margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1.5px solid var(--border);
}
.cat-add-form { margin-bottom: 12px; }
.cat-add-row {
  display: flex; gap: 8px; align-items: center;
}
.emoji-picker-wrap { position: relative; flex-shrink: 0; }
.emoji-display {
  width: 42px; height: 42px;
  background: var(--rose-ll);
  border: 1.5px solid var(--border);
  border-radius: 10px; cursor: pointer;
  font-size: 20px; line-height: 1;
  transition: border-color 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.emoji-display:hover { border-color: var(--rose); }
.emoji-picker {
  display: none;
  position: absolute; top: 48px; left: 0;
  background: white; border: 1.5px solid var(--border);
  border-radius: 14px; padding: 10px;
  box-shadow: 0 8px 24px var(--shadow);
  z-index: 500; width: 240px;
  flex-wrap: wrap; gap: 4px;
}
.emoji-picker.open { display: flex; }
.emoji-opt {
  width: 32px; height: 32px;
  border: none; background: none;
  cursor: pointer; font-size: 18px;
  border-radius: 8px; transition: background 0.15s;
  display: flex; align-items: center; justify-content: center;
}
.emoji-opt:hover { background: var(--rose-ll); }
.custom-cat-badge {
  font-size: 10px; color: var(--rose);
  background: var(--rose-ll); border-radius: 6px;
  padding: 1px 6px; margin-left: 4px;
  font-family: 'Zen Maru Gothic', sans-serif;
}

/* ===== PERIOD SUMMARY ===== */
.period-result {
  margin-top: 14px;
  background: var(--rose-ll);
  border-radius: 14px;
  padding: 14px 16px;
  animation: fadeUp 0.3s ease;
}
.period-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
}
.period-label {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px;
  color: var(--muted);
}
.period-val {
  font-size: 16px;
  font-weight: 700;
}
.period-val.income  { color: var(--mint); }
.period-val.expense { color: var(--rose); }

/* ===== BACKUP MODAL ===== */
#backupModal {
  display: none; position: fixed; inset: 0;
  background: rgba(244,118,138,0.3); backdrop-filter: blur(4px);
  z-index: 9996; align-items: center; justify-content: center;
}
#backupModal.open { display: flex; }
.backup-section-label {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 12px; font-weight: 700; color: var(--ink);
  margin-bottom: 6px;
}
.backup-desc {
  font-family: 'Zen Maru Gothic', sans-serif;
  font-size: 11px; color: var(--muted); line-height: 1.7;
}
.backup-import-row {
  display: flex; align-items: center; gap: 10px; margin-top: 10px;
}
.backup-file-btn {
  background: linear-gradient(135deg, var(--rose-l), var(--cream));
  color: var(--rose-d); border: 1.5px solid var(--border);
  border-radius: 10px; padding: 8px 14px; cursor: pointer;
  font-family: 'Zen Maru Gothic', sans-serif; font-size: 12px;
  font-weight: 700; white-space: nowrap; transition: all 0.2s;
}
.backup-file-btn:hover { border-color: var(--rose); }
#backupFileInput { display: none; }

/* ===== EDIT MODAL ===== */
#editModal {
  display: none; position: fixed; inset: 0;
  background: rgba(244,118,138,0.3); backdrop-filter: blur(4px);
  z-index: 9997; align-items: center; justify-content: center;
}
#editModal.open { display: flex; }

.tx-edit {
  background: none; border: none; cursor: pointer;
  color: var(--border); font-size: 14px; padding: 2px 4px;
  transition: color 0.2s; line-height: 1;
}
.tx-edit:hover { color: var(--rose); }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes shake {
  0%,100% { transform: translateX(0); }
  20% { transform: translateX(-8px); }
  40% { transform: translateX(8px); }
  60% { transform: translateX(-5px); }
  80% { transform: translateX(5px); }
}

@media (max-width: 900px) {
  .main-grid { grid-template-columns: 1fr; }
  .summary-grid { grid-template-columns: 1fr; }
  .charts-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- Lock Screen -->
<div id="lockScreen">
  <div class="lock-box">
    <div class="lock-logo">KAKEIBO</div>
    <div class="lock-sub">ğŸŒ¸ å®¶è¨ˆç°¿ ğŸŒ¸</div>
    <div class="lock-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
    <input type="password" id="lockPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')tryUnlock()">
    <button id="lockBtn" onclick="tryUnlock()">ã²ã‚‰ã ğŸŒ¸</button>
    <div id="lockError"></div>
    <div class="lock-hint">åˆå›ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: kakeibo</div>
  </div>
</div>

<!-- Change Password Modal -->
<div id="pwModal">
  <div class="modal-box">
    <div class="modal-title">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</div>
    <div class="form-row"><label>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label><input type="password" id="pwCurrent" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"></div>
    <div class="form-row"><label>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ4æ–‡å­—ä»¥ä¸Šï¼‰</label><input type="password" id="pwNew" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"></div>
    <div class="form-row"><label>ç¢ºèª</label><input type="password" id="pwConfirm" placeholder="ã‚‚ã†ä¸€åº¦å…¥åŠ›"></div>
    <div id="pwModalError" style="font-family:'Zen Maru Gothic',sans-serif;font-size:11px;color:var(--rose);min-height:16px;margin-bottom:4px;"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closePwModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" onclick="saveNewPassword()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- Backup Modal -->
<div id="backupModal">
  <div class="modal-box" style="width:380px">
    <div class="modal-title">âš™ï¸ è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>

    <div style="margin-bottom:18px">
      <div class="backup-section-label">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
      <p class="backup-desc">ä»•è¨³ãƒ«ãƒ¼ãƒ«ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚</p>
      <button class="btn-submit" style="margin-top:8px" onclick="exportBackup()">ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <div style="border-top:1.5px solid var(--border);padding-top:16px">
      <div class="backup-section-label">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
      <p class="backup-desc">ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§è¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã€‚<br>
        <span style="color:var(--rose-d);font-weight:700">âš ï¸ ç¾åœ¨ã®ä»•è¨³ãƒ«ãƒ¼ãƒ«ãƒ»ã‚«ãƒ†ã‚´ãƒªã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚</span>
      </p>
      <div class="backup-import-row">
        <label class="backup-file-btn" for="backupFileInput">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
        <input type="file" id="backupFileInput" accept=".json" onchange="importBackup(this)">
        <span id="backupFileName" style="font-size:11px;color:var(--muted);font-family:'Zen Maru Gothic',sans-serif;">æœªé¸æŠ</span>
      </div>
    </div>

    <div id="backupStatus" style="font-family:'Zen Maru Gothic',sans-serif;font-size:11px;min-height:16px;margin-top:12px;"></div>

    <div class="modal-actions" style="margin-top:12px">
      <button class="btn-cancel" style="grid-column:1/3" onclick="closeBackupModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>
<div id="editModal">
  <div class="modal-box" style="width:360px">
    <div class="modal-title">âœï¸ è¨˜éŒ²ã‚’ç·¨é›†</div>
    <input type="hidden" id="editId">
    <div class="form-row"><label>ç¨®åˆ¥</label>
      <div class="type-toggle">
        <button id="edit-btn-income"  onclick="setEditType('income')">ï¼‹ åå…¥</button>
        <button id="edit-btn-expense" onclick="setEditType('expense')">ï¼ æ”¯å‡º</button>
      </div>
    </div>
    <div class="form-row"><label>æ—¥ä»˜</label><input type="date" id="editDate"></div>
    <div class="form-row"><label>ã‚«ãƒ†ã‚´ãƒª</label><select id="editCategory"></select></div>
    <div class="form-row"><label>å†…å®¹</label><input type="text" id="editDesc"></div>
    <div class="form-row"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input type="number" id="editAmount" min="0" step="1"></div>
    <div class="form-row"><label>ãƒ¡ãƒ¢</label><input type="text" id="editMemo"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-save" onclick="saveEditTransaction()">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>
</div>

<header>
  <div class="logo">KAKEIBO</div>
  <div class="header-right">
    <span id="wsStatus">â—‹ æœªæ¥ç¶š</span>
    <div class="month-nav">
      <button onclick="changeMonth(-1)">â€¹</button>
      <span id="currentMonth"></span>
      <button onclick="changeMonth(1)">â€º</button>
    </div>
    <button id="changePwBtn" onclick="openPwModal()">ğŸ”‘ PWå¤‰æ›´</button>
    <button id="changePwBtn" onclick="openBackupModal()" style="background:rgba(255,255,255,0.2)">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
  </div>
</header>

<div class="sync-notice" id="syncNotice"></div>

<div class="container">
  <div class="summary-grid">
    <div class="summary-card income" style="animation-delay:0s">
      <div class="card-label">ğŸ’š åå…¥</div>
      <div class="card-amount income" id="totalIncome">Â¥0</div>
      <div class="card-sub" id="incomeCount">0ä»¶</div>
    </div>
    <div class="summary-card expense" style="animation-delay:0.08s">
      <div class="card-label">ğŸŒ¹ æ”¯å‡º</div>
      <div class="card-amount expense" id="totalExpense">Â¥0</div>
      <div class="card-sub" id="expenseCount">0ä»¶</div>
    </div>
    <div class="summary-card balance" style="animation-delay:0.16s">
      <div class="card-label">âœ¨ æ®‹é«˜</div>
      <div class="card-amount" id="totalBalance">Â¥0</div>
      <div class="card-sub" id="savingRate">è²¯è“„ç‡ â€”</div>
    </div>
  </div>

  <div class="main-grid">
    <!-- Left column -->
    <div style="display:flex;flex-direction:column;gap:16px">

      <!-- CSV Upload -->
      <div class="panel">
        <div class="panel-header">ğŸ“Š CSVã‹ã‚‰å–è¾¼ã¿</div>
        <div style="padding:12px 20px 0;font-size:11px;color:var(--muted);font-family:'Zen Maru Gothic',sans-serif;line-height:1.8;">
          åŒåãƒ•ã‚¡ã‚¤ãƒ« â†’ ä¸Šæ›¸ãæ›´æ–°ã€€/ã€€åˆ¥å â†’ è¿½è¨˜
        </div>
        <div class="csv-zone" onclick="document.getElementById('csvInput').click()" id="csvZone">
          <div class="csv-icon">ğŸ“‚</div>
          <p>CSVã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</p>
          <p style="margin-top:4px;font-size:10px">ã‚«ãƒ¼ãƒ‰æ˜ç´°ãƒ»éŠ€è¡Œæ˜ç´°ãªã©</p>
        </div>
        <input type="file" id="csvInput" accept=".csv">
        <div class="csv-status" id="csvStatus"></div>
      </div>

      <!-- æœŸé–“é›†è¨ˆ -->
      <div class="panel">
        <div class="panel-header">ğŸ“… æœŸé–“é›†è¨ˆ</div>
        <div class="form-body">
          <div class="form-row"><label>é–‹å§‹æ—¥</label><input type="date" id="periodFrom"></div>
          <div class="form-row"><label>çµ‚äº†æ—¥</label><input type="date" id="periodTo"></div>
          <button class="btn-submit" onclick="calcPeriod()">é›†è¨ˆã™ã‚‹</button>
          <div id="periodResult" class="period-result" style="display:none">
            <div class="period-row">
              <span class="period-label">ğŸ’š ç´¯è¨ˆåå…¥</span>
              <span class="period-val income" id="pIncome">Â¥0</span>
            </div>
            <div class="period-row">
              <span class="period-label">ğŸŒ¹ ç´¯è¨ˆæ”¯å‡º</span>
              <span class="period-val expense" id="pExpense">Â¥0</span>
            </div>
            <div class="period-row" style="border-top:1.5px solid var(--border);padding-top:10px;margin-top:4px">
              <span class="period-label">âœ¨ ç´¯è¨ˆè²¯é‡‘</span>
              <span class="period-val" id="pBalance">Â¥0</span>
            </div>
            <div class="period-row">
              <span class="period-label">ğŸ“Š è²¯è“„ç‡</span>
              <span class="period-val" id="pRate" style="color:var(--lavender)">â€”</span>
            </div>
            <div id="pRange" style="font-size:10px;color:var(--muted);font-family:'Zen Maru Gothic',sans-serif;margin-top:8px;text-align:right"></div>
          </div>
        </div>
      </div>

      <!-- Default Monthly Income -->
      <div class="panel">
        <div class="panel-header">ğŸ’° æœˆæ¬¡ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåå…¥</div>
        <div class="form-body">
          <p class="income-hint">æ¯æœˆ1æ—¥ã«è‡ªå‹•ç™»éŒ²ã•ã‚Œã¾ã™ã€‚<br>å¤‰æ›´å¾Œã¯ã€Œä¿å­˜ã—ã¦ä»Šæœˆã«åæ˜ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
          <div class="form-row"><label>ğŸ§‘ éºŸå¤ªéƒï¼ˆå††/æœˆï¼‰</label><input type="number" id="defaultIncome1" placeholder="50000" min="0" step="1000"></div>
          <div class="form-row"><label>ğŸ‘© æœ‰å½©ï¼ˆå††/æœˆï¼‰</label><input type="number" id="defaultIncome2" placeholder="50000" min="0" step="1000"></div>
          <div style="margin-top:6px">
            <button class="btn-submit" onclick="saveDefaultIncome()">ä¿å­˜ã—ã¦ä»Šæœˆã«åæ˜ </button>
          </div>
          <div id="defaultIncomeStatus"></div>
        </div>
      </div>

      <!-- Add Transaction -->
      <div class="panel">
        <div class="panel-header">ğŸŒ¸ è¨˜éŒ²ã‚’è¿½åŠ </div>
        <div class="form-body">
          <div class="form-row">
            <label>ç¨®åˆ¥</label>
            <div class="type-toggle">
              <button id="btn-income" class="active-income" onclick="setType('income')">ï¼‹ åå…¥</button>
              <button id="btn-expense" onclick="setType('expense')">ï¼ æ”¯å‡º</button>
            </div>
          </div>
          <div class="form-row"><label>æ—¥ä»˜</label><input type="date" id="txDate"></div>
          <div class="form-row"><label>ã‚«ãƒ†ã‚´ãƒª</label><select id="txCategory"></select></div>
          <div class="form-row"><label>å†…å®¹</label><input type="text" id="txDesc" placeholder="ä¾‹ï¼šã‚¹ãƒ¼ãƒ‘ãƒ¼ã§ã®è²·ã„ç‰©"></div>
          <div class="form-row"><label>é‡‘é¡ï¼ˆå††ï¼‰</label><input type="number" id="txAmount" placeholder="0" min="0" step="1"></div>
          <div class="form-row"><label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><input type="text" id="txMemo" placeholder="å‚™è€ƒ"></div>
          <button class="btn-submit" onclick="addTransaction()">è¨˜éŒ²ã™ã‚‹ ğŸŒ¸</button>
        </div>
      </div>

    </div>

    <!-- Right: Tabs -->
    <div class="panel">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('list', this)">æ˜ç´°ä¸€è¦§</button>
        <button class="tab" onclick="switchTab('charts', this)">ã‚°ãƒ©ãƒ•</button>
        <button class="tab" onclick="switchTab('rules', this)">ğŸ·ï¸ ä»•åˆ†ã‘ãƒ«ãƒ¼ãƒ«</button>
      </div>

      <div class="tab-content active" id="tab-list">
        <div class="tx-list" id="txList"><div class="empty-state">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div></div>
      </div>

      <div class="tab-content" id="tab-charts">
        <div class="charts-grid">
          <div><div class="chart-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰</div><canvas id="catPieChart" height="220"></canvas></div>
          <div><div class="chart-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºï¼ˆé‡‘é¡ï¼‰</div><canvas id="catChart" height="220"></canvas></div>
        </div>
        <div class="chart-full">
          <div class="chart-title">æœˆé–“æ¨ç§»ï¼ˆéå»6ãƒ¶æœˆï¼‰</div>
          <canvas id="lineChart" height="150"></canvas>
        </div>
      </div>

      <div class="tab-content" id="tab-rules">
        <div class="rules-panel">

          <!-- ã‚«ãƒ†ã‚´ãƒªç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="rules-section-title">ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªç®¡ç†</div>
          <div class="rules-hint">
            ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã§ãã¾ã™ã€‚å‰Šé™¤ã™ã‚‹ã¨æ—¢å­˜ã®è¨˜éŒ²ã¯ã€Œãã®ä»–ã€ã«å¤‰ã‚ã‚Šã¾ã™ã€‚
          </div>

          <div class="cat-add-form">
            <div class="cat-add-row">
              <div class="emoji-picker-wrap">
                <button class="emoji-display" id="selectedEmoji" onclick="toggleEmojiPicker()">ğŸ·ï¸</button>
                <div class="emoji-picker" id="emojiPicker"></div>
              </div>
              <input type="text" id="newCatLabel" placeholder="ã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹ï¼šãƒšãƒƒãƒˆï¼‰" style="flex:1;margin-bottom:0">
              <select id="newCatType" style="width:90px;margin-bottom:0">
                <option value="expense">æ”¯å‡º</option>
                <option value="income">åå…¥</option>
              </select>
              <button class="rules-add-btn" onclick="addCustomCategory()">è¿½åŠ </button>
            </div>
          </div>

          <div id="customCatList" class="rules-list" style="margin-bottom:20px"></div>

          <!-- ä»•åˆ†ã‘ãƒ«ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="rules-section-title">ğŸ·ï¸ ä»•åˆ†ã‘ãƒ«ãƒ¼ãƒ«</div>
          <div class="rules-hint">
            ç™»éŒ²ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€åº—åã¯è¨­å®šã‚«ãƒ†ã‚´ãƒªã«è‡ªå‹•åˆ†é¡ã•ã‚Œã¾ã™ã€‚<br>
            ç™»éŒ²ãŒãªã„ãƒ»ä¸€è‡´ã—ãªã„å ´åˆã¯ã€Œãã®ä»–ã€ã«ãªã‚Šã¾ã™ã€‚åŠè§’ãƒ»å…¨è§’ã‚«ãƒŠã¯è‡ªå‹•çµ±ä¸€ã€‚
          </div>
          <div class="rules-add-row">
            <input type="text" id="ruleKeyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šï¾ï¾™ï¾ï¾ï¼‰" style="flex:1">
            <select id="ruleCategory" style="flex:1"></select>
            <button class="rules-add-btn" onclick="addCustomRule()">è¿½åŠ </button>
          </div>
          <div id="rulesList" class="rules-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// =========== ãƒ‡ãƒ¼ã‚¿ ===========
const CUSTOM_CATS_KEY = 'kakeibo_custom_cats';

const BASE_CATEGORIES = {
  income: [
    { id:'salary',   label:'çµ¦ä¸',     emoji:'ğŸ’¼' },
    { id:'bonus',    label:'è³ä¸',     emoji:'ğŸ' },
    { id:'invest',   label:'æŠ•è³‡',     emoji:'ğŸ“ˆ' },
    { id:'other_in', label:'ãã®ä»–åå…¥', emoji:'ğŸ’°' },
  ],
  expense: [
    { id:'food',          label:'é£Ÿè²»',    emoji:'ğŸ±' },
    { id:'dining',        label:'å¤–é£Ÿ',    emoji:'ğŸœ' },
    { id:'housing',       label:'ä½å±…',    emoji:'ğŸ ' },
    { id:'utility',       label:'å…‰ç†±è²»',  emoji:'ğŸ’¡' },
    { id:'transport',     label:'äº¤é€šè²»',  emoji:'ğŸšƒ' },
    { id:'medical',       label:'åŒ»ç™‚',    emoji:'ğŸ¥' },
    { id:'clothing',      label:'è¡£é¡',    emoji:'ğŸ‘—' },
    { id:'education',     label:'æ•™è‚²',    emoji:'ğŸ“š' },
    { id:'entertainment', label:'å¨¯æ¥½',    emoji:'ğŸ®' },
    { id:'subscription',  label:'ã‚µãƒ–ã‚¹ã‚¯', emoji:'ğŸ“±' },
    { id:'insurance',     label:'ä¿é™º',    emoji:'ğŸ›¡ï¸' },
    { id:'other_ex',      label:'ãã®ä»–',  emoji:'ğŸ·ï¸' },
  ]
};

function getCustomCats() {
  try { return JSON.parse(localStorage.getItem(CUSTOM_CATS_KEY) || '[]'); }
  catch { return []; }
}
function saveCustomCats(cats) {
  localStorage.setItem(CUSTOM_CATS_KEY, JSON.stringify(cats));
}

// CATEGORIES ã¯å‹•çš„ã«æ§‹ç¯‰ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªã‚’ã€Œãã®ä»–ã€ã®ç›´å‰ã«æŒ¿å…¥ï¼‰
function buildCategories() {
  const custom = getCustomCats();
  const incCustom = custom.filter(c => c.type === 'income');
  const expCustom = custom.filter(c => c.type === 'expense');

  const incBase = [...BASE_CATEGORIES.income];
  const expBase = [...BASE_CATEGORIES.expense];

  // ã€Œãã®ä»–ã€ã®ç›´å‰ã«ã‚«ã‚¹ã‚¿ãƒ ã‚’æŒ¿å…¥
  const incOtherIdx = incBase.findIndex(c => c.id === 'other_in');
  incBase.splice(incOtherIdx, 0, ...incCustom);

  const expOtherIdx = expBase.findIndex(c => c.id === 'other_ex');
  expBase.splice(expOtherIdx, 0, ...expCustom);

  return { income: incBase, expense: expBase };
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªCATEGORIESï¼ˆèµ·å‹•æ™‚ãƒ»ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ã«å†æ§‹ç¯‰ï¼‰
let CATEGORIES = buildCategories();

let currentType = 'income';
let currentDate = new Date();
let transactions = JSON.parse(localStorage.getItem('kakeibo_tx') || '[]');
let pieChart, catPieChart, catChart, lineChart;

// =========== Init ===========
function init() {
  document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
  updateMonthDisplay();
  setType('income');
  setupCsvUpload();
  initDefaultIncomeUI();
  initRulesUI();
  initEmojiPicker();
  renderCustomCats();
  initPeriodUI();
  ensureDefaultIncomeForCurrentMonth();
  render();
}

function save() { localStorage.setItem('kakeibo_tx', JSON.stringify(transactions)); }
function fmt(n) { return 'Â¥' + Math.abs(n).toLocaleString('ja-JP'); }
function currentMonthKey() {
  return `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
}
function monthTransactions() {
  return transactions.filter(t => t.date.startsWith(currentMonthKey()));
}

// =========== Month Nav ===========
function updateMonthDisplay() {
  document.getElementById('currentMonth').textContent =
    `${currentDate.getFullYear()}å¹´${currentDate.getMonth()+1}æœˆ`;
}
function changeMonth(d) {
  currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth()+d, 1);
  updateMonthDisplay();
  ensureDefaultIncomeForCurrentMonth();
  render();
}

// =========== Form ===========
function setType(type) {
  currentType = type;
  document.getElementById('btn-income').className  = type==='income'  ? 'active-income'  : '';
  document.getElementById('btn-expense').className = type==='expense' ? 'active-expense' : '';
  document.getElementById('txCategory').innerHTML =
    CATEGORIES[type].map(c=>`<option value="${c.id}">${c.emoji} ${c.label}</option>`).join('');
}

function addTransaction(data) {
  const tx = data || {
    date:     document.getElementById('txDate').value,
    type:     currentType,
    category: document.getElementById('txCategory').value,
    desc:     document.getElementById('txDesc').value.trim(),
    amount:   parseFloat(document.getElementById('txAmount').value),
    memo:     document.getElementById('txMemo').value.trim(),
  };
  if (!tx.date || !tx.desc || !tx.amount || tx.amount<=0) {
    alert('æ—¥ä»˜ãƒ»å†…å®¹ãƒ»é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }
  tx.id = Date.now() + Math.random();
  transactions.unshift(tx);
  save(); render();
  if (!data) {
    document.getElementById('txDesc').value='';
    document.getElementById('txAmount').value='';
    document.getElementById('txMemo').value='';
  }
}

function deleteTransaction(id) {
  transactions = transactions.filter(t=>t.id!==id);
  save(); render();
}

// =========== Render ===========
function render() {
  const txs = monthTransactions();
  const income  = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  const expense = txs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
  const balance = income - expense;

  document.getElementById('totalIncome').textContent  = fmt(income);
  document.getElementById('incomeCount').textContent  = txs.filter(t=>t.type==='income').length+'ä»¶';
  document.getElementById('totalExpense').textContent = fmt(expense);
  document.getElementById('expenseCount').textContent = txs.filter(t=>t.type==='expense').length+'ä»¶';

  const balEl = document.getElementById('totalBalance');
  balEl.textContent = (balance>=0?'+':'-')+fmt(balance);
  balEl.className = 'card-amount '+(balance>=0?'balance-positive':'balance-negative');

  const rate = income>0 ? Math.round(balance/income*100) : 0;
  document.getElementById('savingRate').textContent = `è²¯è“„ç‡ ${rate}%`;

  renderList(txs);
  renderCharts(txs, income, expense);
}

function getCatInfo(type, id) {
  return (CATEGORIES[type]||[]).find(c=>c.id===id) || {label:id, emoji:'ğŸ·ï¸'};
}

function renderList(txs) {
  const el = document.getElementById('txList');
  if (!txs.length) { el.innerHTML='<div class="empty-state">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  const sorted = [...txs].sort((a,b)=>b.date.localeCompare(a.date));
  el.innerHTML = sorted.map(t => {
    const cat = getCatInfo(t.type, t.category);
    return `<div class="tx-item">
      <div class="tx-date">${t.date.substring(5)}</div>
      <div class="tx-cat">${cat.emoji}</div>
      <div style="flex:1">
        <div class="tx-desc">${escHtml(t.desc)}</div>
        <div class="tx-memo">${cat.label}${t.memo?' Â· '+escHtml(t.memo):''}</div>
      </div>
      <div class="tx-amount ${t.type}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div>
      <button class="tx-edit" onclick="openEditModal(${t.id})" title="ç·¨é›†">âœ</button>
      <button class="tx-del" onclick="deleteTransaction(${t.id})" title="å‰Šé™¤">Ã—</button>
    </div>`;
  }).join('');
}

function renderCharts(txs, income, expense) {
  const PINK = ['#f4768a','#ffb3c1','#c77dff','#ff8fa3','#ffd6e7','#52b788','#a8dadc','#e9a84c','#f9c784','#b5ead7','#c9f0d0','#ffc8a2'];

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥æ”¯å‡ºãƒ‡ãƒ¼ã‚¿
  const expCats={};
  txs.filter(t=>t.type==='expense').forEach(t=>{ expCats[t.category]=(expCats[t.category]||0)+t.amount; });
  const catEntries=Object.entries(expCats).sort((a,b)=>b[1]-a[1]);

  // â‘  ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ‰ãƒ¼ãƒŠãƒ„ï¼ˆå·¦ï¼‰
  if(catPieChart) catPieChart.destroy();
  if(catEntries.length===0){
    const ctx=document.getElementById('catPieChart').getContext('2d');
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
    catPieChart=null;
  } else {
    catPieChart = new Chart(document.getElementById('catPieChart').getContext('2d'),{
      type:'doughnut',
      data:{
        labels: catEntries.map(([id])=>getCatInfo('expense',id).emoji+' '+getCatInfo('expense',id).label),
        datasets:[{data:catEntries.map(([,v])=>v),backgroundColor:PINK.slice(0,catEntries.length),borderWidth:2,borderColor:'#fff'}]
      },
      options:{
        plugins:{
          legend:{position:'bottom',labels:{font:{family:'Zen Maru Gothic',size:10},boxWidth:10,padding:8}},
          tooltip:{callbacks:{label: ctx => {
            const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
            const pct   = total > 0 ? Math.round(ctx.raw / total * 100) : 0;
            return `${ctx.label}: Â¥${ctx.raw.toLocaleString()}ï¼ˆ${pct}%ï¼‰`;
          }}},
          centerText:{ total: expense }
        },
        cutout:'60%'
      }
    });
  }

  // â‘¡ ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¨ªæ£’ï¼ˆå³ï¼‰
  const topCats=catEntries.slice(0,7);
  if(catChart) catChart.destroy();
  catChart = new Chart(document.getElementById('catChart').getContext('2d'),{
    type:'bar',
    data:{
      labels:topCats.map(([id])=>getCatInfo('expense',id).emoji+' '+getCatInfo('expense',id).label),
      datasets:[{data:topCats.map(([,v])=>v),backgroundColor:PINK.slice(0,topCats.length),borderWidth:0,borderRadius:6}]
    },
    options:{
      indexAxis:'y',
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`Â¥${ctx.raw.toLocaleString()}`}}},
      scales:{
        x:{ticks:{font:{family:'Zen Maru Gothic',size:10},callback:v=>'Â¥'+v.toLocaleString()},grid:{color:'#fce4ea'}},
        y:{ticks:{font:{family:'Zen Maru Gothic',size:10}}}
      }
    }
  });

  // â‘¢ æœˆé–“æ¨ç§»ï¼ˆä¸‹ï¼‰
  const months=[]; const incData=[]; const expData=[];
  for(let i=5;i>=0;i--){
    const d=new Date(currentDate.getFullYear(),currentDate.getMonth()-i,1);
    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const mTxs=transactions.filter(t=>t.date.startsWith(key));
    months.push(`${d.getMonth()+1}æœˆ`);
    incData.push(mTxs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0));
    expData.push(mTxs.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0));
  }
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(document.getElementById('lineChart').getContext('2d'),{
    type:'line',
    data:{
      labels:months,
      datasets:[
        {label:'åå…¥',data:incData,borderColor:'#52b788',backgroundColor:'rgba(82,183,136,0.1)',tension:0.4,fill:true,pointBackgroundColor:'#52b788',pointRadius:4},
        {label:'æ”¯å‡º',data:expData,borderColor:'#f4768a',backgroundColor:'rgba(244,118,138,0.1)',tension:0.4,fill:true,pointBackgroundColor:'#f4768a',pointRadius:4}
      ]
    },
    options:{
      plugins:{legend:{labels:{font:{family:'Zen Maru Gothic',size:11}}}},
      scales:{
        y:{ticks:{font:{family:'Zen Maru Gothic',size:10},callback:v=>'Â¥'+v.toLocaleString()},grid:{color:'#fce4ea'}},
        x:{ticks:{font:{family:'Zen Maru Gothic',size:11}}}
      }
    }
  });
}

// =========== Tabs ===========
function switchTab(name, btn) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');
  if(name==='charts') setTimeout(()=>render(),50);
  if(name==='rules') { renderRules(); renderCustomCats(); }
}

// =========== CSV æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ===========
function setupCsvUpload() {
  const zone  = document.getElementById('csvZone');
  const input = document.getElementById('csvInput');
  zone.addEventListener('dragover', e=>{e.preventDefault();zone.classList.add('dragover');});
  zone.addEventListener('dragleave', ()=>zone.classList.remove('dragover'));
  zone.addEventListener('drop', e=>{
    e.preventDefault(); zone.classList.remove('dragover');
    const file=e.dataTransfer.files[0];
    if(file&&file.name.toLowerCase().endsWith('.csv')) processCSV(file);
    else alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
  });
  input.addEventListener('change', e=>{
    if(e.target.files[0]) processCSV(e.target.files[0]);
    input.value='';
  });
}

function processCSV(file) {
  setCsvStatus('loading', 'ğŸ“Š CSVã‚’èª­ã¿è¾¼ã¿ä¸­...');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const txs = parseCSV(e.target.result, file.name);
      if(!txs.length){ setCsvStatus('error','âœ— å–å¼•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ—åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
      handleIncomingTransactions({source_file:file.name, transactions:txs, count:txs.length});
      setCsvStatus('success', `âœ“ ${txs.length}ä»¶ã‚’å–è¾¼ã¿ã¾ã—ãŸï¼ˆ${file.name}ï¼‰`);
    } catch(err){ setCsvStatus('error',`âœ— ã‚¨ãƒ©ãƒ¼: ${err.message}`); }
  };
  reader.onerror = ()=>setCsvStatus('error','âœ— ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
  // Shift-JISå¯¾å¿œ
  reader.readAsText(file, 'UTF-8');
}

// =========== åŠè§’ã‚«ãƒŠ â†’ å…¨è§’ã‚«ãƒŠ æ­£è¦åŒ– ===========
const HANKAKU_MAP = {
  'ï½¦':'ãƒ²','ï½§':'ã‚¡','ï½¨':'ã‚£','ï½©':'ã‚¥','ï½ª':'ã‚§','ï½«':'ã‚©','ï½¬':'ãƒ£','ï½­':'ãƒ¥','ï½®':'ãƒ§',
  'ï½¯':'ãƒƒ','ï½°':'ãƒ¼','ï½±':'ã‚¢','ï½²':'ã‚¤','ï½³':'ã‚¦','ï½´':'ã‚¨','ï½µ':'ã‚ª','ï½¶':'ã‚«','ï½·':'ã‚­',
  'ï½¸':'ã‚¯','ï½¹':'ã‚±','ï½º':'ã‚³','ï½»':'ã‚µ','ï½¼':'ã‚·','ï½½':'ã‚¹','ï½¾':'ã‚»','ï½¿':'ã‚½','ï¾€':'ã‚¿',
  'ï¾':'ãƒ','ï¾‚':'ãƒ„','ï¾ƒ':'ãƒ†','ï¾„':'ãƒˆ','ï¾…':'ãƒŠ','ï¾†':'ãƒ‹','ï¾‡':'ãƒŒ','ï¾ˆ':'ãƒ','ï¾‰':'ãƒ',
  'ï¾Š':'ãƒ','ï¾‹':'ãƒ’','ï¾Œ':'ãƒ•','ï¾':'ãƒ˜','ï¾':'ãƒ›','ï¾':'ãƒ','ï¾':'ãƒŸ','ï¾‘':'ãƒ ','ï¾’':'ãƒ¡',
  'ï¾“':'ãƒ¢','ï¾”':'ãƒ¤','ï¾•':'ãƒ¦','ï¾–':'ãƒ¨','ï¾—':'ãƒ©','ï¾˜':'ãƒª','ï¾™':'ãƒ«','ï¾š':'ãƒ¬','ï¾›':'ãƒ­',
  'ï¾œ':'ãƒ¯','ï¾':'ãƒ³',
};
// æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ï¼šåŠè§’ã‚«ãƒŠå¤‰æ›ã‚ˆã‚Šå…ˆã«å‡¦ç†ï¼ˆï¾Šï¾â†’ãƒ ãªã©2æ–‡å­—ã‚»ãƒƒãƒˆã‚’å…ˆã«ç½®æ›ï¼‰
const DAKUTEN_MAP = {
  'ï½¶ï¾':'ã‚¬','ï½·ï¾':'ã‚®','ï½¸ï¾':'ã‚°','ï½¹ï¾':'ã‚²','ï½ºï¾':'ã‚´',
  'ï½»ï¾':'ã‚¶','ï½¼ï¾':'ã‚¸','ï½½ï¾':'ã‚º','ï½¾ï¾':'ã‚¼','ï½¿ï¾':'ã‚¾',
  'ï¾€ï¾':'ãƒ€','ï¾ï¾':'ãƒ‚','ï¾‚ï¾':'ãƒ…','ï¾ƒï¾':'ãƒ‡','ï¾„ï¾':'ãƒ‰',
  'ï¾Šï¾':'ãƒ','ï¾‹ï¾':'ãƒ“','ï¾Œï¾':'ãƒ–','ï¾ï¾':'ãƒ™','ï¾ï¾':'ãƒœ',
  'ï¾Šï¾Ÿ':'ãƒ‘','ï¾‹ï¾Ÿ':'ãƒ”','ï¾Œï¾Ÿ':'ãƒ—','ï¾ï¾Ÿ':'ãƒš','ï¾ï¾Ÿ':'ãƒ',
  'ï½³ï¾':'ãƒ´',
};

function normalizeDesc(s) {
  if (!s) return '';
  let r = String(s);
  // â‘  æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ã®2æ–‡å­—ã‚»ãƒƒãƒˆã‚’å…ˆã«å…¨è§’ã«å¤‰æ›ï¼ˆé †åºé‡è¦ï¼‰
  for (const [k, v] of Object.entries(DAKUTEN_MAP)) r = r.split(k).join(v);
  // â‘¡ æ®‹ã‚Šã®åŠè§’ã‚«ãƒŠã‚’å…¨è§’ã«å¤‰æ›
  r = r.replace(/[ï½¦-ï¾Ÿ]/g, c => HANKAKU_MAP[c] || c);
  return r;
}

// =========== æœŸé–“é›†è¨ˆ ===========
function initPeriodUI() {
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šä»Šæœˆã®1æ—¥ã€œä»Šæ—¥
  const now   = new Date();
  const from  = new Date(now.getFullYear(), now.getMonth(), 1);
  document.getElementById('periodFrom').value = from.toISOString().split('T')[0];
  document.getElementById('periodTo').value   = now.toISOString().split('T')[0];
}

function calcPeriod() {
  const from = document.getElementById('periodFrom').value;
  const to   = document.getElementById('periodTo').value;
  if (!from || !to) { alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (from > to)    { alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„'); return; }

  const txs     = transactions.filter(t => t.date >= from && t.date <= to);
  const income  = txs.filter(t => t.type === 'income').reduce((s,t) => s+t.amount, 0);
  const expense = txs.filter(t => t.type === 'expense').reduce((s,t) => s+t.amount, 0);
  const balance = income - expense;
  const rate    = income > 0 ? Math.round(balance / income * 100) : 0;

  document.getElementById('pIncome').textContent  = fmt(income);
  document.getElementById('pExpense').textContent = fmt(expense);

  const balEl = document.getElementById('pBalance');
  balEl.textContent = (balance >= 0 ? '+' : '-') + fmt(balance);
  balEl.style.color = balance >= 0 ? 'var(--lavender)' : 'var(--rose-d)';

  document.getElementById('pRate').textContent = income > 0 ? `${rate}%` : 'â€”';
  document.getElementById('pRange').textContent = `${from} ã€œ ${to}ï¼ˆ${txs.length}ä»¶ï¼‰`;
  document.getElementById('periodResult').style.display = 'block';
}

// =========== Chart.js ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼šãƒ‰ãƒ¼ãƒŠãƒ„ä¸­å¤®ãƒ†ã‚­ã‚¹ãƒˆ ===========
const centerTextPlugin = {
  id: 'centerText',
  afterDraw(chart) {
    if (chart.config.type !== 'doughnut') return;
    const total = chart.config.options?.plugins?.centerText?.total;
    if (total == null) return;

    const { ctx, chartArea: { left, right, top, bottom } } = chart;
    const cx = (left + right) / 2;
    const cy = (top + bottom) / 2;

    ctx.save();
    // ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆ
    ctx.font = `400 10px 'Zen Maru Gothic', sans-serif`;
    ctx.fillStyle = '#b8849a';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('æ”¯å‡ºåˆè¨ˆ', cx, cy - 11);
    // ãƒ¡ã‚¤ãƒ³é‡‘é¡
    ctx.font = `700 15px 'Noto Sans JP', sans-serif`;
    ctx.fillStyle = '#e05570';
    ctx.fillText('Â¥' + Math.round(total).toLocaleString('ja-JP'), cx, cy + 8);
    ctx.restore();
  }
};
Chart.register(centerTextPlugin);
const CUSTOM_RULES_KEY = 'kakeibo_custom_rules';

function getCustomRules() {
  try { return JSON.parse(localStorage.getItem(CUSTOM_RULES_KEY) || '[]'); }
  catch { return []; }
}
function saveCustomRules(rules) {
  localStorage.setItem(CUSTOM_RULES_KEY, JSON.stringify(rules));
}

function addCustomRule() {
  const kw  = document.getElementById('ruleKeyword').value.trim();
  const cat = document.getElementById('ruleCategory').value;
  if (!kw) { alert('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const rules = getCustomRules();
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  if (rules.some(r => normalizeDesc(r.keyword) === normalizeDesc(kw))) {
    alert('åŒã˜ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'); return;
  }
  rules.unshift({ keyword: kw, category: cat });
  saveCustomRules(rules);
  document.getElementById('ruleKeyword').value = '';
  renderRules();
}

function deleteCustomRule(idx) {
  const rules = getCustomRules();
  rules.splice(idx, 1);
  saveCustomRules(rules);
  renderRules();
}

function renderRules() {
  const rules = getCustomRules();
  const allCats = [...CATEGORIES.income, ...CATEGORIES.expense];
  const el = document.getElementById('rulesList');
  if (!el) return;
  if (!rules.length) {
    el.innerHTML = '<div class="rules-empty">ãƒ«ãƒ¼ãƒ«ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'; return;
  }
  el.innerHTML = rules.map((r, i) => {
    const cat = allCats.find(c => c.id === r.category) || { emoji:'ğŸ·ï¸', label: r.category };
    return `<div class="rule-item">
      <div class="rule-keyword">${escHtml(r.keyword)}</div>
      <div class="rule-arrow">â†’</div>
      <div class="rule-cat">${cat.emoji} ${cat.label}</div>
      <button class="rule-del" onclick="deleteCustomRule(${i})" title="å‰Šé™¤">Ã—</button>
    </div>`;
  }).join('');
}

function initRulesUI() {
  const sel = document.getElementById('ruleCategory');
  if (!sel) return;
  const allCats = [...CATEGORIES.expense, ...CATEGORIES.income];
  sel.innerHTML = allCats.map(c => `<option value="${c.id}">${c.emoji} ${c.label}</option>`).join('');
  renderRules();
}

// =========== ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªç®¡ç† ===========
const EMOJI_LIST = [
  'ğŸ¶','ğŸ±','ğŸ°','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¦Š','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸ§','ğŸ¦','ğŸ¦†',
  'ğŸŒ¸','ğŸŒº','ğŸŒ»','ğŸŒ¹','ğŸ€','ğŸŒ¿','ğŸŒµ','ğŸ‹','ğŸ','ğŸŒ¾',
  'ğŸ','ğŸŠ','ğŸ‹','ğŸ‡','ğŸ“','ğŸ”','ğŸ•','ğŸœ','ğŸ£','ğŸ±','ğŸ°','â˜•','ğŸ§‹','ğŸº',
  'âœˆï¸','ğŸš—','ğŸš²','â›µ','ğŸ ','ğŸ¢','ğŸª','ğŸ¡','ğŸ–ï¸','ğŸ”ï¸',
  'ğŸ’»','ğŸ“±','ğŸ®','ğŸµ','ğŸ¸','ğŸ¹','ğŸ¨','ğŸ“·','ğŸ“š','âœï¸','ğŸ“','ğŸ“Œ',
  'ğŸ’ª','ğŸƒ','âš½','ğŸ€','ğŸ¾','ğŸŠ','ğŸ§˜','ğŸ›ï¸','ğŸ‘—','ğŸ‘Ÿ','ğŸ’','ğŸ’„',
  'ğŸ’Š','ğŸ¥','ğŸ’‰','ğŸ§´','ğŸ§¸','ğŸ','ğŸ€','ğŸŠ','ğŸ‰','â­','âœ¨','ğŸ’–','ğŸŒˆ','ğŸ”¥',
  'ğŸ¾','ğŸ ','ğŸ¦œ','ğŸŒ™','â˜€ï¸','ğŸƒ','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’œ',
];

let selectedEmojiValue = 'ğŸ·ï¸';

function initEmojiPicker() {
  const picker = document.getElementById('emojiPicker');
  if (!picker) return;
  picker.innerHTML = EMOJI_LIST.map(e =>
    `<button class="emoji-opt" onclick="selectEmoji('${e}')">${e}</button>`
  ).join('');
  // å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.addEventListener('click', e => {
    if (!e.target.closest('.emoji-picker-wrap')) closEmojiPicker();
  });
}

function toggleEmojiPicker() {
  document.getElementById('emojiPicker').classList.toggle('open');
}
function closEmojiPicker() {
  const p = document.getElementById('emojiPicker');
  if (p) p.classList.remove('open');
}
function selectEmoji(emoji) {
  selectedEmojiValue = emoji;
  document.getElementById('selectedEmoji').textContent = emoji;
  closEmojiPicker();
}

function addCustomCategory() {
  const label = document.getElementById('newCatLabel').value.trim();
  const type  = document.getElementById('newCatType').value;
  if (!label) { alert('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  const custom = getCustomCats();
  // IDï¼šã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯
  const id = 'custom_' + Date.now();
  custom.push({ id, label, emoji: selectedEmojiValue, type });
  saveCustomCats(custom);

  // CATEGORIES ã‚’å†æ§‹ç¯‰ã—ã¦å…¨UIã«åæ˜ 
  CATEGORIES = buildCategories();
  setType(currentType);         // ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
  initRulesUI();                // ä»•åˆ†ã‘ãƒ«ãƒ¼ãƒ«ã®ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
  renderCustomCats();

  document.getElementById('newCatLabel').value = '';
  selectedEmojiValue = 'ğŸ·ï¸';
  document.getElementById('selectedEmoji').textContent = 'ğŸ·ï¸';
}

function deleteCustomCategory(id) {
  if (!confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nè©²å½“ã‚«ãƒ†ã‚´ãƒªã®è¨˜éŒ²ã¯ã€Œãã®ä»–ã€ã«å¤‰ã‚ã‚Šã¾ã™ã€‚')) return;

  // æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã€Œãã®ä»–ã€ã«ç½®æ›
  const fallback = CATEGORIES.income.find(c=>c.id===id) ? 'other_in' : 'other_ex';
  transactions = transactions.map(t => t.category === id ? {...t, category: fallback} : t);
  save();

  // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰å‰Šé™¤
  saveCustomCats(getCustomCats().filter(c => c.id !== id));

  // CATEGORIES å†æ§‹ç¯‰ãƒ»UIæ›´æ–°
  CATEGORIES = buildCategories();
  setType(currentType);
  initRulesUI();
  renderCustomCats();
  render();
}

function renderCustomCats() {
  const el = document.getElementById('customCatList');
  if (!el) return;
  const custom = getCustomCats();
  if (!custom.length) {
    el.innerHTML = '<div class="rules-empty">ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  el.innerHTML = custom.map(c => `
    <div class="rule-item">
      <div style="font-size:20px;min-width:28px;text-align:center">${c.emoji}</div>
      <div class="rule-keyword">${escHtml(c.label)}</div>
      <div class="rule-cat">${c.type === 'income' ? 'åå…¥' : 'æ”¯å‡º'}</div>
      <button class="rule-del" onclick="deleteCustomCategory('${c.id}')" title="å‰Šé™¤">Ã—</button>
    </div>`
  ).join('');
}

// =========== ã‚«ãƒ†ã‚´ãƒªåˆ¤å®šï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã®ã¿ï¼‰ ===========
const INCOME_CATS_JS = new Set(['salary','bonus','invest']);

function guessCategory(desc, type) {
  const normalized = normalizeDesc(desc);

  // ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«ã‚’é †ç•ªã«ãƒã‚§ãƒƒã‚¯ï¼ˆç™»éŒ²é †ãŒå„ªå…ˆï¼‰
  for (const rule of getCustomRules()) {
    if (normalized.includes(normalizeDesc(rule.keyword))) {
      return rule.category;
    }
  }

  // ãƒãƒƒãƒã—ãªã‘ã‚Œã°ãã®ä»–
  return type === 'income' ? 'other_in' : 'other_ex';
}

function cleanAmt(s){ return parseFloat((s||'').replace(/[,Â¥å††\s]/g,''))||0; }

function parseDate(s){
  if(!s||!s.trim()) return null;
  const m=s.match(/(\d{4})[\/\-å¹´](\d{1,2})[\/\-æœˆ](\d{1,2})/);
  if(m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
  const m2=s.match(/^(\d{4})(\d{2})(\d{2})$/);
  if(m2) return `${m2[1]}-${m2[2]}-${m2[3]}`;
  return null;
}

function splitCSVLine(line){
  const result=[]; let cur='',inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){inQ=!inQ;}
    else if(c===','&&!inQ){result.push(cur.trim());cur='';}
    else cur+=c;
  }
  result.push(cur.trim());
  return result;
}

function parseCSV(text, filename){
  text=text.replace(/^\uFEFF/,'');
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2) return [];

  const headers=splitCSVLine(lines[0]);
  const find=(...keys)=>headers.findIndex(h=>keys.some(k=>h.includes(k)));

  // â˜… ä¿®æ­£ï¼šåˆ©ç”¨æ—¥ãƒ»åˆ©ç”¨åº—åãƒ»åˆ©ç”¨é‡‘é¡ã«å¯¾å¿œ
  const iDate    = find('åˆ©ç”¨æ—¥','æ—¥ä»˜','å–å¼•æ—¥','å¹´æœˆæ—¥','æ±ºæ¸ˆæ—¥','date','Date');
  const iDesc    = find('åˆ©ç”¨åº—å','åº—å','å†…å®¹','æ‘˜è¦','èª¬æ˜','å“å','å•†å“','åº—èˆ—','description');
  const iUser    = find('åˆ©ç”¨è€…');
  const iAmount  = find('åˆ©ç”¨é‡‘é¡','æ”¯æ‰•ç·é¡','æ”¯æ‰•é‡‘é¡','é‡‘é¡','amount','å¼•è½','åˆè¨ˆ');
  const iIncome  = find('å…¥é‡‘','åå…¥','income');
  const iExpense = find('å‡ºé‡‘','æ”¯å‡º','expense','å¼•è½é‡‘é¡');

  const txs=[];
  for(let i=1;i<lines.length;i++){
    const cols=splitCSVLine(lines[i]);
    if(!cols.length) continue;

    // æ—¥ä»˜ï¼šCSVã®å€¤ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã§ä¸Šæ›¸ãã—ãªã„ï¼‰
    const rawDate=iDate>=0?cols[iDate]:'';
    const date=parseDate(rawDate);
    if(!date) continue;

    const desc=(iDesc>=0?cols[iDesc]:cols.join(' ')).trim().slice(0,60);
    if(!desc) continue;

    const user=iUser>=0?cols[iUser].trim():'';

    let amount,type;
    if(iIncome>=0&&iExpense>=0){
      const inc=cleanAmt(cols[iIncome]);
      const exp=cleanAmt(cols[iExpense]);
      if(inc>0){amount=inc;type='income';}
      else if(exp>0){amount=exp;type='expense';}
      else continue;
    } else if(iAmount>=0){
      amount=cleanAmt(cols[iAmount]);
      if(!amount) continue;
      if(amount<0){amount=Math.abs(amount);type='income';}
      else type='expense';
    } else continue;

    if(amount<=0) continue;

    txs.push({
      date, type,
      category: guessCategory(desc,type),
      desc, amount,
      memo: user?`${user} / CSV: ${filename}`:`CSV: ${filename}`,
      source_file: filename,
    });
  }
  return txs;
}

function setCsvStatus(type,msg){
  const el=document.getElementById('csvStatus');
  el.style.display='block';
  el.className='csv-status '+type;
  el.textContent=msg;
}

// =========== WebSocket è‡ªå‹•åŒæœŸ ===========
const WS_PORT=8765;
let ws=null, wsReconnectTimer=null;

function connectWS(){
  if(ws&&ws.readyState===WebSocket.OPEN) return;
  try{
    ws=new WebSocket(`ws://localhost:${WS_PORT}`);
    ws.onopen=()=>{
      setWsStatus('connected');
      if(wsReconnectTimer){clearTimeout(wsReconnectTimer);wsReconnectTimer=null;}
    };
    ws.onmessage=e=>{
      let msg; try{msg=JSON.parse(e.data);}catch{return;}
      if(msg.type==='transactions') handleIncomingTransactions(msg);
      else if(msg.type==='error') showSyncNotice('error',msg.message);
    };
    ws.onerror=()=>setWsStatus('error');
    ws.onclose=()=>{setWsStatus('disconnected');wsReconnectTimer=setTimeout(connectWS,5000);};
  }catch(e){setWsStatus('disconnected');wsReconnectTimer=setTimeout(connectWS,5000);}
}

function setWsStatus(status){
  const el=document.getElementById('wsStatus');
  if(!el) return;
  const map={connected:{text:'â— åŒæœŸä¸­',color:'rgba(255,255,255,0.9)'},disconnected:{text:'â—‹ æœªæ¥ç¶š',color:'rgba(255,255,255,0.5)'},error:{text:'âœ• ã‚¨ãƒ©ãƒ¼',color:'rgba(255,255,255,0.7)'}};
  const s=map[status]||map.disconnected;
  el.textContent=s.text; el.style.color=s.color;
}

function handleIncomingTransactions(msg){
  const {source_file, transactions:txs, count}=msg;
  const before=transactions.length;
  transactions=transactions.filter(t=>t.source_file!==source_file);
  const removed=before-transactions.length;
  txs.forEach(tx=>{
    if(tx.date&&tx.desc&&tx.amount>0&&tx.type){
      tx.id=Date.now()+Math.random();
      transactions.unshift(tx);
    }
  });
  save(); render();
  const notice=removed>0?`ã€Œ${source_file}ã€ã‚’ä¸Šæ›¸ãæ›´æ–°ï¼ˆ${removed}ä»¶å‰Šé™¤ â†’ ${count}ä»¶è¿½åŠ ï¼‰`:`ã€Œ${source_file}ã€ã‚’è¿½è¨˜ï¼ˆ${count}ä»¶è¿½åŠ ï¼‰`;
  showSyncNotice('success',notice);
}

function showSyncNotice(type,text){
  const el=document.getElementById('syncNotice');
  if(!el) return;
  el.textContent=text; el.className='sync-notice '+type; el.style.display='block';
  setTimeout(()=>{el.style.display='none';},6000);
}

// =========== ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœˆæ¬¡åå…¥ ===========
const DEFAULT_INCOME_KEY='kakeibo_default_income';
const DEFAULT_INCOME_APPLIED_KEY='kakeibo_income_applied';

function getDefaultIncome(){
  const saved=localStorage.getItem(DEFAULT_INCOME_KEY);
  return saved?JSON.parse(saved):{person1:50000,person2:50000};
}

function saveDefaultIncome(){
  const v1=parseInt(document.getElementById('defaultIncome1').value)||0;
  const v2=parseInt(document.getElementById('defaultIncome2').value)||0;
  localStorage.setItem(DEFAULT_INCOME_KEY,JSON.stringify({person1:v1,person2:v2}));
  // â˜… ä¿®æ­£ï¼šä¿å­˜ã¨åŒæ™‚ã«ä»Šæœˆã®appliedã‚­ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å¼·åˆ¶å†é©ç”¨
  const key=`${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
  localStorage.removeItem(`${DEFAULT_INCOME_APPLIED_KEY}_${key}`);
  applyDefaultIncomeForMonth(currentDate.getFullYear(),currentDate.getMonth()+1,true);
  render();
  const el=document.getElementById('defaultIncomeStatus');
  el.style.color='var(--mint)';
  el.textContent=`âœ“ ä¿å­˜ãƒ»åæ˜ ã—ã¾ã—ãŸï¼ˆéºŸå¤ªéƒ ${fmt(v1)} + æœ‰å½© ${fmt(v2)} = ${fmt(v1+v2)}/æœˆï¼‰`;
  setTimeout(()=>{el.textContent='';},5000);
}

function applyDefaultIncomeNow(){
  const key=`${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
  localStorage.removeItem(`${DEFAULT_INCOME_APPLIED_KEY}_${key}`);
  applyDefaultIncomeForMonth(currentDate.getFullYear(),currentDate.getMonth()+1,true);
  render();
  const el=document.getElementById('defaultIncomeStatus');
  el.style.color='var(--mint)';
  el.textContent=`âœ“ ${currentDate.getMonth()+1}æœˆã«é©ç”¨ã—ã¾ã—ãŸ`;
  setTimeout(()=>{el.textContent='';},3000);
}

function applyDefaultIncomeForMonth(year,month,force=false){
  const key=`${year}-${String(month).padStart(2,'0')}`;
  const appliedKey=`${DEFAULT_INCOME_APPLIED_KEY}_${key}`;
  if(!force&&localStorage.getItem(appliedKey)) return;
  const {person1,person2}=getDefaultIncome();
  if(person1<=0&&person2<=0) return;
  const dateStr=`${key}-01`;
  transactions=transactions.filter(t=>!(t.source_file==='__default_income__'&&t.date.startsWith(key)));
  if(person1>0) transactions.push({id:Date.now()+Math.random(),date:dateStr,type:'income',category:'salary',desc:'éºŸå¤ªéƒ æœˆæ¬¡åå…¥',amount:person1,memo:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåå…¥',source_file:'__default_income__'});
  if(person2>0) transactions.push({id:Date.now()+Math.random(),date:dateStr,type:'income',category:'salary',desc:'æœ‰å½© æœˆæ¬¡åå…¥',  amount:person2,memo:'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåå…¥',source_file:'__default_income__'});
  localStorage.setItem(appliedKey,'1');
  save();
}

function ensureDefaultIncomeForCurrentMonth(){
  applyDefaultIncomeForMonth(currentDate.getFullYear(),currentDate.getMonth()+1,false);
}

function initDefaultIncomeUI(){
  const {person1,person2}=getDefaultIncome();
  document.getElementById('defaultIncome1').value=person1;
  document.getElementById('defaultIncome2').value=person2;
}

// =========== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ===========
let editType = 'expense';

function openEditModal(id) {
  const tx = transactions.find(t => t.id === id);
  if (!tx) return;
  editType = tx.type;
  document.getElementById('editId').value = id;
  document.getElementById('editDate').value = tx.date;
  document.getElementById('editDesc').value = tx.desc;
  document.getElementById('editAmount').value = tx.amount;
  document.getElementById('editMemo').value = tx.memo || '';
  setEditType(tx.type, tx.category);
  document.getElementById('editModal').classList.add('open');
}

function setEditType(type, selectedCat) {
  editType = type;
  document.getElementById('edit-btn-income').className  = type==='income'  ? 'active-income'  : '';
  document.getElementById('edit-btn-expense').className = type==='expense' ? 'active-expense' : '';
  const sel = document.getElementById('editCategory');
  sel.innerHTML = CATEGORIES[type].map(c=>`<option value="${c.id}">${c.emoji} ${c.label}</option>`).join('');
  if (selectedCat) sel.value = selectedCat;
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('open');
}

function saveEditTransaction() {
  const id    = parseFloat(document.getElementById('editId').value);
  const date  = document.getElementById('editDate').value;
  const desc  = document.getElementById('editDesc').value.trim();
  const amount= parseFloat(document.getElementById('editAmount').value);
  const cat   = document.getElementById('editCategory').value;
  const memo  = document.getElementById('editMemo').value.trim();
  if (!date || !desc || !amount || amount <= 0) { alert('æ—¥ä»˜ãƒ»å†…å®¹ãƒ»é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const idx = transactions.findIndex(t => t.id === id);
  if (idx < 0) return;
  transactions[idx] = { ...transactions[idx], date, type: editType, category: cat, desc, amount, memo };
  save(); render();
  closeEditModal();
}

// =========== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ ===========
function openBackupModal() {
  document.getElementById('backupStatus').textContent = '';
  document.getElementById('backupFileName').textContent = 'æœªé¸æŠ';
  document.getElementById('backupFileInput').value = '';
  document.getElementById('backupModal').classList.add('open');
}
function closeBackupModal() {
  document.getElementById('backupModal').classList.remove('open');
}

function exportBackup() {
  const rules = getCustomRules();
  const cats  = getCustomCats();
  const data  = {
    version: 2,
    exportedAt: new Date().toISOString(),
    customRules: rules,
    customCategories: cats,
  };
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  const date = new Date().toISOString().split('T')[0];
  a.href     = url;
  a.download = `kakeibo_settings_${date}.json`;
  a.click();
  URL.revokeObjectURL(url);

  const el = document.getElementById('backupStatus');
  el.style.color = 'var(--mint)';
  el.textContent = `âœ“ ä¿å­˜ã—ã¾ã—ãŸï¼ˆä»•è¨³ãƒ«ãƒ¼ãƒ«${rules.length}ä»¶ãƒ»ã‚«ãƒ†ã‚´ãƒª${cats.length}ä»¶ï¼‰`;
}

function importBackup(input) {
  const file = input.files[0];
  if (!file) return;
  document.getElementById('backupFileName').textContent = file.name;

  const reader = new FileReader();
  reader.onload = e => {
    const el = document.getElementById('backupStatus');
    try {
      const data = JSON.parse(e.target.result);

      if (!data.version || (!data.customRules && !data.customCategories)) {
        el.style.color = 'var(--rose-d)';
        el.textContent = 'âœ— æœ‰åŠ¹ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“';
        return;
      }

      const rules = data.customRules || [];
      const cats  = data.customCategories || [];

      if (!confirm(`è¨­å®šã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nä»•è¨³ãƒ«ãƒ¼ãƒ«: ${rules.length}ä»¶\nã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒª: ${cats.length}ä»¶\n\nâš ï¸ ç¾åœ¨ã®ä»•è¨³ãƒ«ãƒ¼ãƒ«ãƒ»ã‚«ãƒ†ã‚´ãƒªã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™`)) return;

      saveCustomRules(rules);
      saveCustomCats(cats);

      CATEGORIES = buildCategories();
      setType(currentType);
      initRulesUI();
      renderCustomCats();
      render();

      el.style.color = 'var(--mint)';
      el.textContent = `âœ“ å¾©å…ƒã—ã¾ã—ãŸï¼ˆä»•è¨³ãƒ«ãƒ¼ãƒ«${rules.length}ä»¶ãƒ»ã‚«ãƒ†ã‚´ãƒª${cats.length}ä»¶ï¼‰`;

    } catch(err) {
      el.style.color = 'var(--rose-d)';
      el.textContent = `âœ— èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${err.message}`;
    }
  };
  reader.readAsText(file, 'UTF-8');
}

// =========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===========
function escHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// =========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ===========
const DEFAULT_PW='kakeibo', PW_KEY='kakeibo_pw_hash', SESSION_KEY='kakeibo_unlocked';
function hashPw(pw){ let h=0;for(let i=0;i<pw.length;i++)h=Math.imul(31,h)+pw.charCodeAt(i)|0;return String(h>>>0); }
function getStoredHash(){ return localStorage.getItem(PW_KEY)||hashPw(DEFAULT_PW); }
function isUnlocked(){ return sessionStorage.getItem(SESSION_KEY)==='yes'; }

function tryUnlock(){
  const input=document.getElementById('lockPassword').value;
  if(!input) return;
  if(hashPw(input)===getStoredHash()){
    sessionStorage.setItem(SESSION_KEY,'yes');
    document.getElementById('lockScreen').classList.add('hidden');
    document.getElementById('lockError').textContent='';
    init(); connectWS();
  } else {
    const inp=document.getElementById('lockPassword');
    inp.classList.add('shake');
    setTimeout(()=>inp.classList.remove('shake'),400);
    document.getElementById('lockError').textContent='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ ğŸŒ¹';
    inp.value='';
  }
}
function openPwModal(){ document.getElementById('pwCurrent').value='';document.getElementById('pwNew').value='';document.getElementById('pwConfirm').value='';document.getElementById('pwModalError').textContent='';document.getElementById('pwModal').classList.add('open'); }
function closePwModal(){ document.getElementById('pwModal').classList.remove('open'); }
function saveNewPassword(){
  const cur=document.getElementById('pwCurrent').value;
  const nw=document.getElementById('pwNew').value;
  const cf=document.getElementById('pwConfirm').value;
  const errEl=document.getElementById('pwModalError');
  if(hashPw(cur)!==getStoredHash()){errEl.textContent='ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';return;}
  if(nw.length<4){errEl.textContent='4æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„';return;}
  if(nw!==cf){errEl.textContent='ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“';return;}
  localStorage.setItem(PW_KEY,hashPw(nw));
  closePwModal(); alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ ğŸŒ¸');
}

// =========== Start ===========
if(isUnlocked()){
  document.getElementById('lockScreen').classList.add('hidden');
  init(); connectWS();
} else {
  document.getElementById('lockPassword').focus();
}
</script>
</body>
</html>
